name: wormhole-build
on:
  push:
    tags: ["v*"]   # push a tag like v0.1.0

jobs:
  build:
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        py: ["3.12"]
    runs-on: ${{ matrix.os }}

    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.py }}

      # Install uv
      - name: Install uv (unix)
        if: runner.os != 'Windows'
        run: curl -LsSf https://astral.sh/uv/install.sh | sh
      - name: Install uv (windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: iwr https://astral.sh/uv/install.ps1 -UseBasicParsing | iex

      # Sync deps and install PyInstaller
      - name: Sync deps
        run: |
          uv sync --all-extras --dev
          uv pip install pyinstaller

      # Build one-folder
      - name: PyInstaller (one-folder)
        run: uv run pyinstaller wormhole.spec

      # --- LINUX: .desktop (GUI) ---
      - name: Linux desktop launcher
        if: runner.os == 'Linux'
        run: |
          mkdir -p out/linux
          BIN="${PWD}/dist/wormhole/wormhole"
          ICON="${PWD}/packaging/icon.png"
          cat > out/linux/wormhole.desktop <<EOF
          [Desktop Entry]
          Type=Application
          Name=Wormhole
          Exec=${BIN} --gui
          Icon=${ICON}
          Terminal=false
          Categories=Utility;
          EOF
          chmod +x dist/wormhole/wormhole
          cp -r dist/wormhole out/linux/wormhole
          cp out/linux/wormhole.desktop out/linux/
          cp packaging/icon.png out/linux/ || true
          tar -C out/linux -czf wormhole-linux.tar.gz .

      # --- macOS: minimal .app wrapper (GUI) ---
      - name: macOS .app launcher
        if: runner.os == 'macOS'
        run: |
          mkdir -p out/macos/Wormhole.app/Contents/{MacOS,Resources}
          cat > out/macos/Wormhole.app/Contents/Info.plist <<'PLIST'
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0"><dict>
            <key>CFBundleExecutable</key><string>run</string>
            <key>CFBundleIconFile</key><string>applet</string>
            <key>CFBundleName</key><string>Wormhole</string>
          </dict></plist>
          PLIST
          cat > out/macos/Wormhole.app/Contents/MacOS/run <<'EOF'
          #!/bin/sh
          DIR="$(cd "$(dirname "$0")"/../../.. && pwd)"
          exec "$DIR/dist/wormhole/wormhole" --gui
          EOF
          chmod +x out/macos/Wormhole.app/Contents/MacOS/run
          [ -f packaging/icon.icns ] && cp packaging/icon.icns out/macos/Wormhole.app/Contents/Resources/applet.icns
          # package binary + app
          mkdir -p out/macos
          cp -R dist/wormhole out/macos/wormhole
          tar -C out/macos -czf wormhole-macos.tar.gz Wormhole.app wormhole

      # --- Windows: shortcuts (GUI) with hidden console via VBS ---
      - name: Windows shortcuts
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          $bin = "$PWD\dist\wormhole\wormhole.exe"
          # VBS to launch GUI without a console window
          $vbs = @'
          Set oShell = CreateObject("Wscript.Shell")
          Set oFSO = CreateObject("Scripting.FileSystemObject")
          exe = oFSO.BuildPath(WScript.CreateObject("WScript.Shell").CurrentDirectory, "dist\wormhole\wormhole.exe")
          oShell.Run """" & exe & """" & " --gui", 0, False
          '@
          Set-Content -Path Wormhole-GUI.vbs -Value $vbs -Encoding ASCII

          # Desktop shortcuts (GUI and CLI)
          $ws = New-Object -ComObject WScript.Shell
          $desktop = [Environment]::GetFolderPath("Desktop")

          $lnk1 = $ws.CreateShortcut("$desktop\Wormhole (GUI).lnk")
          $lnk1.TargetPath = "wscript.exe"
          $lnk1.Arguments = "`"`"$PWD\Wormhole-GUI.vbs`"`""
          $lnk1.IconLocation = "$PWD\packaging\icon.ico"
          $lnk1.WorkingDirectory = "$PWD\dist\wormhole"
          $lnk1.Save()

          $lnk2 = $ws.CreateShortcut("$desktop\Wormhole (CLI).lnk")
          $lnk2.TargetPath = $bin
          $lnk2.Arguments = ""
          $lnk2.IconLocation = "$PWD\packaging\icon.ico"
          $lnk2.WorkingDirectory = "$PWD\dist\wormhole"
          $lnk2.Save()

          Compress-Archive -Path dist\wormhole\*, Wormhole-GUI.vbs, packaging\icon.ico -DestinationPath wormhole-windows.zip

      - uses: actions/upload-artifact@v4
        with:
          name: wormhole-${{ runner.os }}
          path: |
            wormhole-linux.tar.gz
            wormhole-macos.tar.gz
            wormhole-windows.zip
          if-no-files-found: ignore
