name: wormhole-build

on:
  push:
    tags: ["v*"]    # push a tag like v0.1.0
  workflow_dispatch:

jobs:
  build:
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        py: ["3.12"]
    runs-on: ${{ matrix.os }}

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.py }}

      # ---------- Install uv ----------
      - name: Install uv (Unix)
        if: runner.os != 'Windows'
        run: curl -LsSf https://astral.sh/uv/install.sh | sh
      - name: Install uv (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: iwr https://astral.sh/uv/install.ps1 -UseBasicParsing | iex

      # ---------- Sync deps; add PyInstaller ----------
      - name: Sync deps
        run: |
          uv sync --all-extras --dev
          uv pip install pyinstaller

      # ---------- Build (PyInstaller one-folder) ----------
      - name: PyInstaller (one-folder)
        run: uv run pyinstaller wormhole.spec

      # ---------- Optional smoke tests ----------
      - name: Smoke test (Unix)
        if: runner.os != 'Windows'
        run: ./dist/wormhole/wormhole --help || true
      - name: Smoke test (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: .\dist\wormhole\wormhole.exe --help

      # =====================================================================
      # PORTABLE ARTIFACTS (same as your current zips/tarballs)
      # =====================================================================

      # ---------- Linux: portable tar.gz + .desktop launching --gui ----------
      - name: Portable (Linux tar.gz)
        if: runner.os == 'Linux'
        run: |
          mkdir -p out/linux
          BIN="${PWD}/dist/wormhole/wormhole"
          ICON="${PWD}/packaging/icon.png"
          cat > out/linux/wormhole.desktop <<EOF
          [Desktop Entry]
          Type=Application
          Name=Wormhole
          Exec=${BIN} --gui
          Icon=${ICON}
          Terminal=false
          Categories=Utility;
          EOF
          chmod +x dist/wormhole/wormhole
          cp -r dist/wormhole out/linux/wormhole
          [ -f packaging/icon.png ] && cp packaging/icon.png out/linux/
          tar -C out/linux -czf wormhole-linux.tar.gz .

      # ---------- macOS: portable tar.gz + tiny .app launcher calling --gui ----------
      - name: Build minimal macOS .app launcher
        if: runner.os == 'macOS'
        run: |
          mkdir -p out/macos/Wormhole.app/Contents/{MacOS,Resources}
          cat > out/macos/Wormhole.app/Contents/Info.plist <<'PLIST'
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0"><dict>
            <key>CFBundleExecutable</key><string>run</string>
            <key>CFBundleIconFile</key><string>applet</string>
            <key>CFBundleName</key><string>Wormhole</string>
          </dict></plist>
          PLIST
          cat > out/macos/Wormhole.app/Contents/MacOS/run <<'EOF'
          #!/bin/sh
          DIR="$(cd "$(dirname "$0")"/../../.. && pwd)"
          exec "$DIR/dist/wormhole/wormhole" --gui
          EOF
          chmod +x out/macos/Wormhole.app/Contents/MacOS/run
          [ -f packaging/icon.icns ] && cp packaging/icon.icns out/macos/Wormhole.app/Contents/Resources/applet.icns
      - name: Portable (macOS tar.gz)
        if: runner.os == 'macOS'
        run: |
          mkdir -p out/macos
          cp -R dist/wormhole out/macos/wormhole
          tar -C out/macos -czf wormhole-macos.tar.gz Wormhole.app wormhole

      # ---------- Windows: portable zip + VBS GUI launcher ----------
      - name: Portable (Windows zip)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          Copy-Item Wormhole-GUI.vbs .
          if (Test-Path packaging\icon.ico) { $icon = 'packaging\icon.ico' } else { $icon = $null }
          # Create GUI and CLI desktop shortcuts for convenience when testing artifacts
          $ws = New-Object -ComObject WScript.Shell
          $desktop = [Environment]::GetFolderPath("Desktop")
          $lnk1 = $ws.CreateShortcut("$desktop\Wormhole (GUI).lnk")
          $lnk1.TargetPath = "wscript.exe"
          $lnk1.Arguments = "`"`"$PWD\Wormhole-GUI.vbs`"`""
          if ($icon) { $lnk1.IconLocation = "$PWD\$icon" }
          $lnk1.WorkingDirectory = "$PWD\dist\wormhole"
          $lnk1.Save()
          $lnk2 = $ws.CreateShortcut("$desktop\Wormhole (CLI).lnk")
          $lnk2.TargetPath = "$PWD\dist\wormhole\wormhole.exe"
          if ($icon) { $lnk2.IconLocation = "$PWD\$icon" }
          $lnk2.WorkingDirectory = "$PWD\dist\wormhole"
          $lnk2.Save()
          Compress-Archive -Path dist\wormhole\*, Wormhole-GUI.vbs -DestinationPath wormhole-windows.zip

      # Upload portable artifacts (what you already had)
      - uses: actions/upload-artifact@v4
        with:
          name: wormhole-${{ runner.os }}-portable
          path: |
            wormhole-linux.tar.gz
            wormhole-macos.tar.gz
            wormhole-windows.zip
          if-no-files-found: ignore

      # =====================================================================
      # INSTALLERS (automatic installation, double-click experience)
      # =====================================================================

      # ---------- Windows installer (Inno Setup) ----------
      - name: Install Inno Setup
        if: runner.os == 'Windows'
        shell: pwsh
        run: choco install innosetup -y
      - name: Build Windows installer
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          Set-Content VERSION (git describe --tags --always)
          Copy-Item Wormhole-GUI.vbs dist\wormhole\
          & "C:\Program Files (x86)\Inno Setup 6\ISCC.exe" packaging\wormhole.iss
      - name: Upload Windows installer
        if: runner.os == 'Windows'
        uses: actions/upload-artifact@v4
        with:
          name: wormhole-Windows-installer
          path: wormhole-windows-installer.exe

      # ---------- macOS DMG (drag-and-drop) ----------
      - name: Install create-dmg
        if: runner.os == 'macOS'
        run: brew install create-dmg
      - name: Build DMG
        if: runner.os == 'macOS'
        run: |
          mkdir -p out/macos_pkg
          cp -R out/macos/Wormhole.app out/macos_pkg/Wormhole.app
          cp -R dist/wormhole out/macos_pkg/wormhole
          ln -s /Applications out/macos_pkg/Applications
          create-dmg \
            --volname "Wormhole" \
            --window-pos 200 120 \
            --window-size 600 400 \
            --icon "Wormhole.app" 150 200 \
            --icon "Applications" 450 200 \
            wormhole-macos.dmg \
            out/macos_pkg
      - name: Upload macOS DMG
        if: runner.os == 'macOS'
        uses: actions/upload-artifact@v4
        with:
          name: wormhole-macOS-installer
          path: wormhole-macos.dmg

      # ---------- Linux self-extracting installer (.run) ----------
      - name: Install makeself
        if: runner.os == 'Linux'
        run: sudo apt-get update && sudo apt-get install -y makeself
      - name: Build Linux self-installer
        if: runner.os == 'Linux'
        run: |
          chmod +x packaging/install-linux.sh
          makeself --nox11 --notemp . wormhole-linux.run "Wormhole Installer" \
            bash packaging/install-linux.sh
      - name: Upload Linux installer
        if: runner.os == 'Linux'
        uses: actions/upload-artifact@v4
        with:
          name: wormhole-Linux-installer
          path: wormhole-linux.run
